const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HomePresenter-Dyyuibas.js","assets/leaflet-src-BSbcx_7H.js","assets/AddStoryPresenter-BChdVLiH.js"])))=>i.map(i=>d[i]);
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();const T="modulepreload",C=function(c){return"/"+c},S={},u=function(e,t,i){let o=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),r=(n==null?void 0:n.nonce)||(n==null?void 0:n.getAttribute("nonce"));o=Promise.allSettled(t.map(a=>{if(a=C(a),a in S)return;S[a]=!0;const p=a.endsWith(".css"),g=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${g}`))return;const d=document.createElement("link");if(d.rel=p?"stylesheet":T,p||(d.as="script"),d.crossOrigin="",d.href=a,r&&d.setAttribute("nonce",r),document.head.appendChild(d),p)return new Promise((w,f)=>{d.addEventListener("load",w),d.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${a}`)))})}))}function s(n){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=n,window.dispatchEvent(r),!r.defaultPrevented)throw n}return o.then(n=>{for(const r of n||[])r.status==="rejected"&&s(r.reason);return e().catch(s)})},h={home:'<svg class="icon" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9,22 9,12 15,12 15,22"></polyline></svg>',bookOpen:'<svg class="icon" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>',plusCircle:'<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>',user:'<svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',logIn:'<svg class="icon" viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10,17 15,12 10,7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>',logOut:'<svg class="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16,17 21,12 16,7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',userPlus:'<svg class="icon" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>',mapPin:'<svg class="icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',camera:'<svg class="icon" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>',aperture:'<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="14.31" y1="8" x2="20.05" y2="17.94"></line><line x1="9.69" y1="8" x2="21.17" y2="8"></line><line x1="7.38" y1="12" x2="13.12" y2="2.06"></line><line x1="9.69" y1="16" x2="3.95" y2="6.06"></line><line x1="14.31" y1="16" x2="2.83" y2="16"></line><line x1="16.62" y1="12" x2="10.88" y2="21.94"></line></svg>',refreshCw:'<svg class="icon" viewBox="0 0 24 24"><polyline points="23,4 23,10 17,10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>',save:'<svg class="icon" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17,21 17,13 7,13 7,21"></polyline><polyline points="7,3 7,8 15,8"></polyline></svg>',map:'<svg class="icon" viewBox="0 0 24 24"><polygon points="1,6 1,22 8,18 16,22 23,18 23,2 16,6 8,2"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>',upload:'<svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7,10 12,5 17,10"></polyline><line x1="12" y1="5" x2="12" y2="15"></line></svg>',x:'<svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',heart:'<svg class="icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',heartFilled:'<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',trash:'<svg class="icon" viewBox="0 0 24 24"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2 2 0 0 1-2,2H7a2 2 0 0 1-2-2V6m3,0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',download:'<svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7,10 12,15 17,10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',arrowLeft:'<svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12,19 5,12 12,5"></polyline></svg>'};class N{constructor(){this.skipToContentCallback=null,this.navLinkCallback=null,this.logoutCallback=null}init(){this.setupEventListeners()}setupEventListeners(){document.addEventListener("click",e=>{if(e.target.matches(".skip-link-hidden")||e.target.matches(".skip-link"))return e.preventDefault(),e.stopPropagation(),this.skipToContentCallback&&this.skipToContentCallback(),!1;if(e.target.matches(".nav-link")||e.target.closest(".nav-link")){e.preventDefault();const i=(e.target.matches(".nav-link")?e.target:e.target.closest(".nav-link")).getAttribute("href");i&&this.navLinkCallback&&this.navLinkCallback(i)}(e.target.matches(".logout-btn")||e.target.closest(".logout-btn"))&&this.logoutCallback&&this.logoutCallback()}),document.addEventListener("keydown",e=>{if((e.target.matches(".skip-link-hidden")||e.target.matches(".skip-link"))&&(e.key==="Enter"||e.key===" "))return e.preventDefault(),e.stopPropagation(),this.skipToContentCallback&&this.skipToContentCallback(),!1})}onSkipToContent(e){this.skipToContentCallback=e}onNavLinkClick(e){this.navLinkCallback=e}onLogoutClick(e){this.logoutCallback=e}focusMainContent(){const e=document.getElementById("main-content");e&&(e.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{e.focus()},300))}renderNavigation(e,t=null){const i=document.getElementById("main-nav");if(i)if(e){const o=(t==null?void 0:t.name)||"User";i.innerHTML=`
      <div class="nav-brand">
        ${h.bookOpen}
        <h1 class="site-title">Story Explorer</h1>
      </div>
      <div class="nav-right">
        <ul class="nav-menu" role="menubar" aria-label="Main menu">
          <li role="none">
            <a href="#home" class="nav-link active" role="menuitem" aria-label="Go to home page" aria-current="page">
              ${h.home}
              <span class="nav-text">Home</span>
            </a>
          </li>
          <li role="none">
            <a href="#add-story" class="nav-link" role="menuitem" aria-label="Add new story">
              ${h.plusCircle}
              <span class="nav-text">Add Story</span>
            </a>
          </li>
          <li role="none">
            <a href="#favorites" class="nav-link" role="menuitem" aria-label="View favorite stories">
              ${h.heart}
              <span class="nav-text">Favorites</span>
            </a>
          </li>
        </ul>
        <div class="user-info" role="complementary" aria-label="User information">
          <span class="user-avatar" aria-hidden="true">${h.user}</span>
          <span class="user-name">${o}</span>
          <button class="logout-btn" type="button" title="Logout" aria-label="Logout from account">
            ${h.logOut}
          </button>
        </div>
      </div>
    `}else i.innerHTML=`
        <div class="nav-brand">
          ${h.bookOpen}
          <h1 class="site-title">Story Explorer</h1>
        </div>
        <ul class="nav-menu" role="menubar" aria-label="Main menu">
          <li role="none">
            <a href="#login" class="nav-link" role="menuitem" aria-label="Go to login page">
              ${h.logIn}
              <span class="nav-text">Login</span>
            </a>
          </li>
        </ul>
      `}updateActiveNavLink(e){document.querySelectorAll(".nav-link").forEach(i=>{i.classList.remove("active"),i.removeAttribute("aria-current"),i.getAttribute("href")===e&&(i.classList.add("active"),i.setAttribute("aria-current","page"))})}confirmLogout(){return confirm("Are you sure you want to logout?")}renderPageContent(e){const t=document.getElementById("app-content");t&&(t.innerHTML=e)}renderNotFoundPage(){return`
      <article class="error-page">
        <header class="error-header">
          <h1 class="error-title">Page Not Found</h1>
        </header>
        <div class="error-content">
          <p class="error-message">The page you are looking for does not exist.</p>
          <nav class="error-nav">
            <a href="#home" class="btn btn-primary">Go to Home</a>
          </nav>
        </div>
      </article>
    `}renderErrorPage(){return`
      <article class="error-page">
        <header class="error-header">
          <h1 class="error-title">Error Loading Page</h1>
        </header>
        <div class="error-content">
          <p class="error-message">There was an error loading the page. Please try again.</p>
          <nav class="error-nav">
            <a href="#home" class="btn btn-primary">Go to Home</a>
          </nav>
        </div>
      </article>
    `}showLoading(){const e=document.getElementById("loading");e&&(e.classList.remove("hidden"),e.setAttribute("aria-busy","true"))}hideLoading(){const e=document.getElementById("loading");e&&(e.classList.add("hidden"),e.setAttribute("aria-busy","false"))}async animatePageTransition(e){const t=document.getElementById("app-content");if(!t)return;t.firstElementChild&&await t.firstElementChild.animate([{transform:"translateX(0)",opacity:1},{transform:"translateX(-100%)",opacity:0}],{duration:300,easing:"ease-in-out"}).finished,await e();const i=t.firstElementChild;i&&i.animate([{transform:"translateX(100%)",opacity:0},{transform:"translateX(0)",opacity:1}],{duration:300,easing:"ease-in-out"})}getContentElement(){return document.getElementById("app-content")}getMainContentElement(){return document.getElementById("main-content")}getLoadingElement(){return document.getElementById("loading")}getNavElement(){return document.getElementById("main-nav")}}class O{constructor(e){this.model=e,this.view=new N,this.currentPresenter=null,this.isTransitioning=!1}init(){this.view.init(),this.setupRouter(),this.setupEventListeners(),this.updateNavigation(),this.handleInitialRoute()}setupRouter(){window.addEventListener("hashchange",()=>{this.handleRouteChange()})}setupEventListeners(){this.view.onSkipToContent(()=>this.handleSkipToContent()),this.view.onNavLinkClick(e=>this.handleNavigation(e)),this.view.onLogoutClick(()=>this.handleLogout())}handleSkipToContent(){this.view.focusMainContent()}handleNavigation(e){window.location.hash=e,this.view.updateActiveNavLink(e)}updateNavigation(){const e=this.model.isAuthenticated(),t=this.model.getCurrentUser();this.view.renderNavigation(e,t)}handleLogout(){this.view.confirmLogout()&&(this.model.logout(),this.updateNavigation(),window.location.hash="#login")}handleInitialRoute(){const e=this.model.isAuthenticated();let t=window.location.hash||"#home";!e&&t!=="#login"&&(t="#login"),window.location.hash=t,this.handleRouteChange()}async handleRouteChange(){if(this.isTransitioning)return;const e=window.location.hash.slice(1)||"home";if(e==="main-content")return;const t=this.model.isAuthenticated();if(["home","add-story","favorites"].includes(e)&&!t){window.location.hash="#login";return}await this.navigateToPage(e)}async navigateToPage(e){if(!this.isTransitioning){this.isTransitioning=!0,this.view.showLoading();try{document.startViewTransition?await document.startViewTransition(async()=>{await this.loadPage(e)}):await this.loadPageWithCustomAnimation(e)}catch(t){console.error("Navigation error:",t)}finally{this.view.hideLoading(),this.isTransitioning=!1}}}async loadPage(e){try{this.currentPresenter&&this.currentPresenter.destroy&&this.currentPresenter.destroy();let t="";switch(e){case"home":const{HomeView:i}=await u(async()=>{const{HomeView:l}=await import("./HomeView-BRPcKWW1.js");return{HomeView:l}},[]),{HomePresenter:o}=await u(async()=>{const{HomePresenter:l}=await import("./HomePresenter-Dyyuibas.js");return{HomePresenter:l}},__vite__mapDeps([0,1])),s=new i,n=new o(this.model,s);t=s.render(),this.currentPresenter=n;break;case"add-story":const{AddStoryView:r}=await u(async()=>{const{AddStoryView:l}=await import("./AddStoryView-BJIY3FrC.js");return{AddStoryView:l}},[]),{AddStoryPresenter:a}=await u(async()=>{const{AddStoryPresenter:l}=await import("./AddStoryPresenter-BChdVLiH.js");return{AddStoryPresenter:l}},__vite__mapDeps([2,1])),p=new r,g=new a(this.model,p);t=p.render(),this.currentPresenter=g;break;case"favorites":const{FavoritesView:d}=await u(async()=>{const{FavoritesView:l}=await import("./FavoritesView-gi4y-tfC.js");return{FavoritesView:l}},[]),{FavoritesPresenter:w}=await u(async()=>{const{FavoritesPresenter:l}=await import("./FavoritesPresenter-Dvow1Yj8.js");return{FavoritesPresenter:l}},[]),f=new d,k=new w(this.model,f);t=f.render(),this.currentPresenter=k;break;case"login":const{LoginView:E}=await u(async()=>{const{LoginView:l}=await import("./LoginView-DIUMFlv2.js");return{LoginView:l}},[]),{LoginPresenter:B}=await u(async()=>{const{LoginPresenter:l}=await import("./LoginPresenter-OVrL9UM3.js");return{LoginPresenter:l}},[]),y=new E,L=new B(this.model,y);t=y.render(),this.currentPresenter=L;break;default:const{NotFoundView:A}=await u(async()=>{const{NotFoundView:l}=await import("./NotFoundView-Djp73vlD.js");return{NotFoundView:l}},[]),b=new A;t=b.render(),this.currentPresenter=b}this.view.renderPageContent(t),this.currentPresenter&&this.currentPresenter.init&&await this.currentPresenter.init(),setTimeout(()=>{this.view.focusMainContent()},100)}catch(t){console.error("Error loading page:",t),this.view.renderErrorPage()}}async loadPageWithCustomAnimation(e){await this.view.animatePageTransition(async()=>{await this.loadPage(e)})}showLoading(){this.view.showLoading()}hideLoading(){this.view.hideLoading()}}class _{constructor(){this.baseURL="https://story-api.dicoding.dev/v1",this.stories=[],this.authToken=localStorage.getItem("authToken"),this.currentUser=null}async register(e){try{const t=await fetch(`${this.baseURL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e.name,email:e.email,password:e.password})}),i=await t.json();if(!t.ok)throw new Error(i.message||"Registration failed");return i}catch(t){throw t}}async login(e){try{const t=await fetch(`${this.baseURL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email,password:e.password})}),i=await t.json();if(!t.ok)throw new Error(i.message||"Login failed");return this.authToken=i.loginResult.token,this.currentUser={name:i.loginResult.name,userId:i.loginResult.userId},localStorage.setItem("authToken",this.authToken),localStorage.setItem("userName",this.currentUser.name),localStorage.setItem("userId",this.currentUser.userId),i}catch(t){throw t}}logout(){this.authToken=null,this.currentUser=null,localStorage.removeItem("authToken"),localStorage.removeItem("userName"),localStorage.removeItem("userId")}isAuthenticated(){return!!this.authToken}getCurrentUser(){return!this.currentUser&&this.authToken&&(this.currentUser={name:localStorage.getItem("userName"),userId:localStorage.getItem("userId")}),this.currentUser}async getAllStories(){try{console.log("Fetching stories with token:",this.authToken?"Token exists":"No token");const e=await fetch(`${this.baseURL}/stories`,{method:"GET",headers:{Authorization:`Bearer ${this.authToken}`,"Content-Type":"application/json"}}),t=await e.json();if(console.log("Stories response:",t),!e.ok)throw new Error(t.message||"Failed to fetch stories");return t&&t.listStory&&Array.isArray(t.listStory)?(this.stories=t.listStory,window.indexedDBService&&await window.indexedDBService.saveStories(this.stories)):(console.warn("Unexpected API response structure, using cached data"),this.stories=await this.getCachedStories()),this.stories}catch(e){return console.error("Error fetching stories:",e),this.stories=await this.getCachedStories(),this.stories}}async getCachedStories(){try{if(window.indexedDBService){const e=await window.indexedDBService.getStories();if(e.length>0)return console.log("Using cached stories from IndexedDB"),e}}catch(e){console.error("Error getting cached stories:",e)}return this.getMockStories()}async getStoryById(e){try{const t=await fetch(`${this.baseURL}/stories/${e}`,{method:"GET",headers:{Authorization:`Bearer ${this.authToken}`,"Content-Type":"application/json"}}),i=await t.json();if(!t.ok)throw new Error(i.message||"Failed to fetch story");return i.story}catch{return this.stories.find(i=>i.id===e)}}async addStory(e){try{console.log("Adding story:",e);const t=new FormData;t.append("description",e.description);const i=Number.parseFloat(e.latitude),o=Number.parseFloat(e.longitude);if(isNaN(i)||isNaN(o))throw new Error("Invalid location coordinates");if(t.append("lat",i.toString()),t.append("lon",o.toString()),e.imageUrl&&e.imageUrl.startsWith("data:"))try{const a=await(await fetch(e.imageUrl)).blob();t.append("photo",a,"story-photo.jpg")}catch(r){throw console.error("Error processing image:",r),new Error("Failed to process image")}else throw new Error("No valid image provided");const s=await fetch(`${this.baseURL}/stories`,{method:"POST",headers:{Authorization:`Bearer ${this.authToken}`},body:t}),n=await s.json();if(console.log("Add story response:",n),!s.ok)throw new Error(n.message||"Failed to add story");return await this.getAllStories(),n}catch(t){throw console.error("Error adding story:",t),!navigator.onLine&&window.indexedDBService?(await window.indexedDBService.addToOfflineQueue({type:"addStory",data:e}),console.log("Story added to offline queue"),new Error("Story saved offline. It will be uploaded when you're back online.")):t}}validateStoryData(e){const t=[];return(!e.description||e.description.trim().length<10)&&t.push("Description must be at least 10 characters long"),e.imageUrl||t.push("Photo is required"),(!e.latitude||!e.longitude)&&t.push("Location is required"),t}validateCredentials(e){const t=[];return(!e.email||!e.email.includes("@"))&&t.push("Valid email is required"),(!e.password||e.password.length<6)&&t.push("Password must be at least 6 characters long"),t}validateRegistrationData(e){const t=[];return(!e.name||e.name.trim().length<2)&&t.push("Name must be at least 2 characters long"),(!e.email||!e.email.includes("@"))&&t.push("Valid email is required"),(!e.password||e.password.length<6)&&t.push("Password must be at least 6 characters long"),t}getMockStories(){return[{id:"story-1",name:"Sample Story 1",description:"This is a sample story from Jakarta. Lorem ipsum dolor sit amet, consectetur adipiscing elit.",photoUrl:"https://picsum.photos/400/300?random=1",createdAt:"2024-01-15T10:30:00.000Z",lat:-6.2088,lon:106.8456},{id:"story-2",name:"Sample Story 2",description:"Another sample story from Bandung. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.",photoUrl:"https://picsum.photos/400/300?random=2",createdAt:"2024-01-14T15:45:00.000Z",lat:-6.9175,lon:107.6191},{id:"story-3",name:"Sample Story 3",description:"A beautiful story from Yogyakarta. Ut enim ad minim veniam, quis nostrud exercitation ullamco.",photoUrl:"https://picsum.photos/400/300?random=3",createdAt:"2024-01-13T08:20:00.000Z",lat:-7.7956,lon:110.3695}]}async addToFavorites(e){if(window.indexedDBService)return await window.indexedDBService.addToFavorites(e);throw new Error("IndexedDB not available")}async removeFromFavorites(e){if(window.indexedDBService)return await window.indexedDBService.removeFromFavorites(e);throw new Error("IndexedDB not available")}async getFavorites(){return window.indexedDBService?await window.indexedDBService.getFavorites():[]}async isFavorite(e){return window.indexedDBService?await window.indexedDBService.isFavorite(e):!1}}class D{constructor(){this.dbName="StoryExplorerDB",this.dbVersion=1,this.db=null}async init(){return new Promise((e,t)=>{const i=indexedDB.open(this.dbName,this.dbVersion);i.onerror=()=>{console.error("IndexedDB error:",i.error),t(i.error)},i.onsuccess=()=>{this.db=i.result,console.log("IndexedDB initialized successfully"),e(this.db)},i.onupgradeneeded=o=>{const s=o.target.result;if(!s.objectStoreNames.contains("stories")){const n=s.createObjectStore("stories",{keyPath:"id"});n.createIndex("createdAt","createdAt",{unique:!1}),n.createIndex("name","name",{unique:!1})}if(s.objectStoreNames.contains("favorites")||s.createObjectStore("favorites",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),!s.objectStoreNames.contains("offlineQueue")){const n=s.createObjectStore("offlineQueue",{keyPath:"id",autoIncrement:!0});n.createIndex("timestamp","timestamp",{unique:!1}),n.createIndex("type","type",{unique:!1})}s.objectStoreNames.contains("preferences")||s.createObjectStore("preferences",{keyPath:"key"}),console.log("IndexedDB schema created/updated")}})}async saveStories(e){this.db||await this.init();const i=this.db.transaction(["stories"],"readwrite").objectStore("stories"),o=e.map(s=>new Promise((n,r)=>{const a=i.put({...s,cachedAt:new Date().toISOString()});a.onsuccess=()=>n(a.result),a.onerror=()=>r(a.error)}));return Promise.all(o)}async getStories(){return this.db||await this.init(),new Promise((e,t)=>{const s=this.db.transaction(["stories"],"readonly").objectStore("stories").getAll();s.onsuccess=()=>{e(s.result||[])},s.onerror=()=>t(s.error)})}async getStoryById(e){return this.db||await this.init(),new Promise((t,i)=>{const n=this.db.transaction(["stories"],"readonly").objectStore("stories").get(e);n.onsuccess=()=>t(n.result),n.onerror=()=>i(n.error)})}async deleteStory(e){return this.db||await this.init(),new Promise((t,i)=>{const n=this.db.transaction(["stories"],"readwrite").objectStore("stories").delete(e);n.onsuccess=()=>t(!0),n.onerror=()=>i(n.error)})}async addToFavorites(e){return this.db||await this.init(),new Promise((t,i)=>{const n=this.db.transaction(["favorites"],"readwrite").objectStore("favorites").put({...e,addedAt:new Date().toISOString()});n.onsuccess=()=>t(n.result),n.onerror=()=>i(n.error)})}async removeFromFavorites(e){return this.db||await this.init(),new Promise((t,i)=>{const n=this.db.transaction(["favorites"],"readwrite").objectStore("favorites").delete(e);n.onsuccess=()=>t(!0),n.onerror=()=>i(n.error)})}async getFavorites(){return this.db||await this.init(),new Promise((e,t)=>{const s=this.db.transaction(["favorites"],"readonly").objectStore("favorites").getAll();s.onsuccess=()=>e(s.result||[]),s.onerror=()=>t(s.error)})}async isFavorite(e){return this.db||await this.init(),new Promise((t,i)=>{const n=this.db.transaction(["favorites"],"readonly").objectStore("favorites").get(e);n.onsuccess=()=>t(!!n.result),n.onerror=()=>i(n.error)})}async addToOfflineQueue(e){return this.db||await this.init(),new Promise((t,i)=>{const n=this.db.transaction(["offlineQueue"],"readwrite").objectStore("offlineQueue").add({...e,timestamp:new Date().toISOString()});n.onsuccess=()=>t(n.result),n.onerror=()=>i(n.error)})}async getOfflineQueue(){return this.db||await this.init(),new Promise((e,t)=>{const s=this.db.transaction(["offlineQueue"],"readonly").objectStore("offlineQueue").getAll();s.onsuccess=()=>e(s.result||[]),s.onerror=()=>t(s.error)})}async removeFromOfflineQueue(e){return this.db||await this.init(),new Promise((t,i)=>{const n=this.db.transaction(["offlineQueue"],"readwrite").objectStore("offlineQueue").delete(e);n.onsuccess=()=>t(!0),n.onerror=()=>i(n.error)})}async clearOfflineQueue(){return this.db||await this.init(),new Promise((e,t)=>{const s=this.db.transaction(["offlineQueue"],"readwrite").objectStore("offlineQueue").clear();s.onsuccess=()=>e(!0),s.onerror=()=>t(s.error)})}async setPreference(e,t){return this.db||await this.init(),new Promise((i,o)=>{const r=this.db.transaction(["preferences"],"readwrite").objectStore("preferences").put({key:e,value:t,updatedAt:new Date().toISOString()});r.onsuccess=()=>i(r.result),r.onerror=()=>o(r.error)})}async getPreference(e){return this.db||await this.init(),new Promise((t,i)=>{const n=this.db.transaction(["preferences"],"readonly").objectStore("preferences").get(e);n.onsuccess=()=>{var r;return t((r=n.result)==null?void 0:r.value)},n.onerror=()=>i(n.error)})}async clearAllData(){this.db||await this.init();const t=["stories","favorites","offlineQueue","preferences"].map(i=>new Promise((o,s)=>{const a=this.db.transaction([i],"readwrite").objectStore(i).clear();a.onsuccess=()=>o(!0),a.onerror=()=>s(a.error)}));return Promise.all(t)}async getStorageInfo(){this.db||await this.init();const e=["stories","favorites","offlineQueue","preferences"],t={};for(const i of e){const n=this.db.transaction([i],"readonly").objectStore("stories").count();t[i]=await new Promise((r,a)=>{n.onsuccess=()=>r(n.result),n.onerror=()=>a(n.error)})}return t}}class F{constructor(){this.vapidPublicKey="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk",this.registration=null,this.subscription=null}async init(){if(!("serviceWorker"in navigator))return console.warn("Service Worker not supported"),!1;if(!("PushManager"in window))return console.warn("Push messaging not supported"),!1;try{return this.registration=await navigator.serviceWorker.register("/sw.js"),console.log("Service Worker registered successfully"),await navigator.serviceWorker.ready,console.log("Service Worker is ready"),!0}catch(e){return console.error("Service Worker registration failed:",e),!1}}async requestPermission(){if(!("Notification"in window))return console.warn("Notifications not supported"),!1;let e=Notification.permission;return e==="default"&&(e=await Notification.requestPermission()),e==="granted"?(console.log("Notification permission granted"),await this.subscribeToPush(),!0):(console.log("Notification permission denied"),!1)}async subscribeToPush(){if(!this.registration)return console.error("Service Worker not registered"),!1;try{return this.subscription=await this.registration.pushManager.getSubscription(),this.subscription||(this.subscription=await this.registration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(this.vapidPublicKey)}),console.log("Push subscription created:",this.subscription)),await this.sendSubscriptionToServer(this.subscription),!0}catch(e){return console.error("Failed to subscribe to push notifications:",e),!1}}async sendSubscriptionToServer(e){localStorage.setItem("pushSubscription",JSON.stringify(e)),console.log("Push subscription stored locally")}async unsubscribe(){if(this.subscription)try{return await this.subscription.unsubscribe(),this.subscription=null,localStorage.removeItem("pushSubscription"),console.log("Unsubscribed from push notifications"),!0}catch(e){return console.error("Failed to unsubscribe:",e),!1}return!1}isSubscribed(){return!!this.subscription}getPermissionStatus(){return"Notification"in window?Notification.permission:"unsupported"}urlBase64ToUint8Array(e){const t="=".repeat((4-e.length%4)%4),i=(e+t).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(i),s=new Uint8Array(o.length);for(let n=0;n<o.length;++n)s[n]=o.charCodeAt(n);return s}async showNotification(e,t={}){if(Notification.permission==="granted"&&this.registration){const o={...{body:"New story available!",icon:"/icons/notification.png",badge:"/icons/notification.png",tag:"story-notification",requireInteraction:!1,actions:[{action:"view",title:"View Story"},{action:"dismiss",title:"Dismiss"}]},...t};try{await this.registration.showNotification(e,o),console.log("Notification shown:",e)}catch(s){console.error("Failed to show notification:",s)}}}}class V{constructor(){this.deferredPrompt=null,this.isInstalled=!1,this.isOnline=navigator.onLine,this.installButton=null,this.installBanner=null}init(){this.setupInstallPrompt(),this.setupOfflineDetection(),this.checkIfInstalled(),this.setupInstallBanner()}setupInstallPrompt(){window.addEventListener("beforeinstallprompt",e=>{console.log("PWA install prompt available"),e.preventDefault(),this.deferredPrompt=e,this.showInstallBanner()}),window.addEventListener("appinstalled",()=>{console.log("PWA was installed"),this.isInstalled=!0,this.hideInstallBanner(),this.deferredPrompt=null,this.showInstallSuccess()})}setupOfflineDetection(){window.addEventListener("online",()=>{console.log("App is online"),this.isOnline=!0,this.hideOfflineIndicator(),this.syncOfflineData()}),window.addEventListener("offline",()=>{console.log("App is offline"),this.isOnline=!1,this.showOfflineIndicator()}),this.isOnline||this.showOfflineIndicator()}checkIfInstalled(){window.matchMedia("(display-mode: standalone)").matches&&(this.isInstalled=!0,console.log("PWA is running in standalone mode")),window.navigator.standalone===!0&&(this.isInstalled=!0,console.log("PWA is running in iOS standalone mode"))}setupInstallBanner(){this.installBanner=document.getElementById("install-banner"),this.installButton=document.getElementById("install-button");const e=document.getElementById("dismiss-install");this.installButton&&this.installButton.addEventListener("click",()=>{this.promptInstall()}),e&&e.addEventListener("click",()=>{this.hideInstallBanner(),localStorage.setItem("installPromptDismissed",Date.now().toString())})}showInstallBanner(){const e=localStorage.getItem("installPromptDismissed");e&&(Date.now()-Number.parseInt(e))/864e5<7||this.isInstalled||this.installBanner&&(this.installBanner.classList.remove("hidden"),this.installBanner.setAttribute("aria-hidden","false"))}hideInstallBanner(){this.installBanner&&(this.installBanner.classList.add("hidden"),this.installBanner.setAttribute("aria-hidden","true"))}async promptInstall(){if(!this.deferredPrompt)return console.log("Install prompt not available"),!1;try{this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;return console.log(`User response to install prompt: ${e}`),console.log(e==="accepted"?"User accepted the install prompt":"User dismissed the install prompt"),this.deferredPrompt=null,this.hideInstallBanner(),e==="accepted"}catch(e){return console.error("Error showing install prompt:",e),!1}}showOfflineIndicator(){const e=document.getElementById("offline-indicator");e&&(e.classList.remove("hidden"),e.setAttribute("aria-hidden","false"))}hideOfflineIndicator(){const e=document.getElementById("offline-indicator");e&&(e.classList.add("hidden"),e.setAttribute("aria-hidden","true"))}showInstallSuccess(){const e=document.createElement("div");e.className="install-success-notification",e.innerHTML=`
        <div class="notification-content">
          <span class="success-icon">✅</span>
          <span class="success-text">Story Explorer installed successfully!</span>
        </div>
      `,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}async syncOfflineData(){if(this.isOnline)try{const e=await window.indexedDBService.getOfflineQueue();if(e.length===0)return;console.log(`Syncing ${e.length} offline actions`);for(const t of e)try{t.type==="addStory"&&(await window.storyModel.addStory(t.data),await window.indexedDBService.removeFromOfflineQueue(t.id),console.log("Synced offline story:",t.id))}catch(i){console.error("Failed to sync offline action:",i)}this.showSyncSuccess(e.length)}catch(e){console.error("Error syncing offline data:",e)}}showSyncSuccess(e){const t=document.createElement("div");t.className="sync-success-notification",t.innerHTML=`
        <div class="notification-content">
          <span class="sync-icon">🔄</span>
          <span class="sync-text">Synced ${e} offline ${e===1?"action":"actions"}</span>
        </div>
      `,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},3e3)}isInstallable(){return!!this.deferredPrompt}isStandalone(){return this.isInstalled}getInstallationStatus(){return{isInstalled:this.isInstalled,isInstallable:this.isInstallable(),isOnline:this.isOnline}}}const P=new D,m=new F,I=new V,x=new _,v=new O(x);window.app=v;window.storyModel=x;window.indexedDBService=P;window.pushNotificationService=m;window.pwaService=I;async function U(){try{console.log("Initializing Story Explorer PWA..."),await P.init(),console.log("IndexedDB initialized"),I.init(),console.log("PWA service initialized"),await m.init()&&(console.log("Push notification service initialized"),setTimeout(()=>{q()},5e3)),v.init(),console.log("Application initialized successfully")}catch(c){console.error("Error initializing application:",c),v.init()}}function q(){if(m.getPermissionStatus()==="default"){const e=document.getElementById("notification-banner"),t=document.getElementById("enable-notifications"),i=document.getElementById("dismiss-notifications");e&&(e.classList.remove("hidden"),t&&t.addEventListener("click",async()=>{await m.requestPermission()&&(e.classList.add("hidden"),setTimeout(()=>{m.showNotification("Notifications Enabled!",{body:"You'll now receive updates about new stories.",tag:"welcome-notification"})},1e3))}),i&&i.addEventListener("click",()=>{e.classList.add("hidden"),localStorage.setItem("notificationPromptDismissed",Date.now().toString())}))}}"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",c=>{if(console.log("Received message from Service Worker:",c.data),c.data.type==="SYNC_COMPLETE"){const e=document.createElement("div");e.className="sync-notification",e.innerHTML=`
        <div class="notification-content">
          <span class="sync-icon">✅</span>
          <span class="sync-text">${c.data.message}</span>
        </div>
      `,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}});U();export{h as I};
