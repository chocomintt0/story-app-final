import{L as o}from"./leaflet-src-BSbcx_7H.js";class l{constructor(t,e){this.model=t,this.view=e,this.map=null,this.selectedLocation=null,this.camera=null,this.capturedImage=null,this.locationMarker=null}async init(){setTimeout(()=>{this.initMap(),this.initCamera(),this.initUpload(),this.initPhotoTabs(),this.initForm()},100)}initMap(){if(this.view.getMapContainer())try{this.map=o.map("add-story-map").setView([-6.2,106.8],6),o.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors"}).addTo(this.map),this.map.on("click",e=>this.selectLocation(e.latlng))}catch(e){console.error("Error initializing map:",e)}}selectLocation(t){this.locationMarker&&this.map.removeLayer(this.locationMarker),this.locationMarker=o.marker([t.lat,t.lng]).addTo(this.map).bindPopup("Lokasi Terpilih").openPopup(),this.selectedLocation={latitude:t.lat,longitude:t.lng},this.view.updateLocationDisplay(t.lat,t.lng),this.view.clearValidationError("location")}initCamera(){var t,e,i;(t=this.view.getStartCameraButton())==null||t.addEventListener("click",()=>this.startCamera()),(e=this.view.getCapturePhotoButton())==null||e.addEventListener("click",()=>this.capturePhoto()),(i=this.view.getRetakePhotoButton())==null||i.addEventListener("click",()=>this.retakePhoto())}async startCamera(){try{const t=await navigator.mediaDevices.getUserMedia({video:{width:400,height:300}});this.camera=t;const e=this.view.getCameraPreviewElement();e.srcObject=t,this.view.showCameraPreview(),this.view.toggleCameraControls(!0,!1)}catch{this.view.showAlert("Tidak dapat mengakses kamera. Pastikan izin telah diberikan.")}}capturePhoto(){const t=this.view.getCameraPreviewElement(),e=this.view.getPhotoCanvasElement(),i=e.getContext("2d");e.width=t.videoWidth,e.height=t.videoHeight,i.drawImage(t,0,0),this.capturedImage=e.toDataURL("image/jpeg",.8),this.view.showPhotoPreview(this.capturedImage,!0),this.view.hideCameraPreview(),this.view.toggleCameraControls(!1,!0),this.view.clearValidationError("photo"),this.stopCamera()}retakePhoto(){this.view.getCapturedPhotoElement().classList.add("hidden"),this.view.toggleCameraControls(!1,!1),this.capturedImage=null}stopCamera(){this.camera&&(this.camera.getTracks().forEach(t=>t.stop()),this.camera=null)}initPhotoTabs(){var t,e;(t=this.view.getCameraTabElement())==null||t.addEventListener("click",()=>{this.view.switchToTab("camera"),this.clearUpload()}),(e=this.view.getUploadTabElement())==null||e.addEventListener("click",()=>{this.view.switchToTab("upload"),this.clearCamera()})}initUpload(){var i;const t=this.view.getUploadAreaElement(),e=this.view.getFileInputElement();t==null||t.addEventListener("click",()=>e.click()),t==null||t.addEventListener("dragover",a=>{a.preventDefault(),t.classList.add("drag-over")}),t==null||t.addEventListener("dragleave",()=>t.classList.remove("drag-over")),t==null||t.addEventListener("drop",a=>{a.preventDefault(),t.classList.remove("drag-over"),a.dataTransfer.files.length>0&&this.handleFileUpload(a.dataTransfer.files[0])}),e==null||e.addEventListener("change",a=>{a.target.files.length>0&&this.handleFileUpload(a.target.files[0])}),(i=this.view.getRemoveUploadButton())==null||i.addEventListener("click",()=>this.clearUpload())}handleFileUpload(t){if(!t.type.startsWith("image/")){this.view.showValidationError("photo","Silakan pilih file gambar.");return}if(t.size>5*1024*1024){this.view.showValidationError("photo","Ukuran file tidak boleh lebih dari 5MB.");return}const e=new FileReader;e.onload=i=>{this.capturedImage=i.target.result,this.view.showPhotoPreview(this.capturedImage,!1),this.view.toggleUploadControls(!0),this.view.clearValidationError("photo")},e.readAsDataURL(t)}clearUpload(){var t;this.view.toggleUploadControls(!1),this.view.clearFileInput(),(t=this.view.getUploadTabElement())!=null&&t.classList.contains("active")&&(this.capturedImage=null)}clearCamera(){var t;this.view.hideCameraPreview(),this.view.getCapturedPhotoElement().classList.add("hidden"),this.view.toggleCameraControls(!1,!1),this.stopCamera(),(t=this.view.getCameraTabElement())!=null&&t.classList.contains("active")&&(this.capturedImage=null)}initForm(){var t;(t=this.view.getFormElement())==null||t.addEventListener("submit",e=>{e.preventDefault(),this.handleFormSubmit()})}async handleFormSubmit(){var a,r;this.view.clearAllValidationErrors();const e={description:this.view.getFormData().get("description"),imageUrl:this.capturedImage,latitude:(a=this.selectedLocation)==null?void 0:a.latitude,longitude:(r=this.selectedLocation)==null?void 0:r.longitude},i=this.model.validateStoryData(e);if(i.length>0){i.forEach(s=>{s.includes("Deskripsi")&&this.view.showValidationError("description",s),s.includes("Foto")&&this.view.showValidationError("photo",s),s.includes("Lokasi")&&this.view.showValidationError("location",s)});return}try{this.view.showLoading(),await this.model.addStory(e),this.view.showAlert("Cerita berhasil ditambahkan!"),this.view.navigateTo("#home")}catch(s){this.view.showAlert(s.message||"Gagal menambahkan cerita. Silakan coba lagi.")}finally{this.view.hideLoading()}}destroy(){this.stopCamera(),this.map&&(this.map.remove(),this.map=null)}}export{l as AddStoryPresenter};
